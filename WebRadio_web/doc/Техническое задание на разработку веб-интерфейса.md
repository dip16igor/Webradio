# Техническое задание на разработку веб-интерфейса управления ESP32 WebRadio с безопасностью «секретная ссылка»

## 1. Общие положения

Цель проекта — создать веб-интерфейс для управления и мониторинга прошивки ESP32 WebRadio через существующий MQTT-брокер Mosquitto. Приложение разворачивается на Ubuntu 22 VPS и подключается к Mosquitto по localhost. Доступ к интерфейсу осуществляется по единственной «секретной» URL-пути, практически не поддающейся угадыванию, без использования HTTPS и классических схем аутентификации.

Исключается разработка прошивки ESP32 — она уже готова. Весь обмен устройством осуществляется через MQTT-топики, структурированные в префиксе `Home/WebRadio2`.

## 2. Функциональные требования

### 2.1. HTTP-MQTT мост

1. Среда исполнения: Node.js ≥ 18
2. Фреймворк: Express.js
3. MQTT-клиент: mqtt npm-пакет
4. Библиотеки: cors, express.json(), (опционально) express.static
5. Запуск моста на порту 3000, привязка к 127.0.0.1
6. Подключение к локальному брокеру:
    - URL: `mqtt://127.0.0.1:1883`
    - Логин/пароль: из `/etc/mosquitto/passwd`

### 2.2. Секретный URL

1. При первом запуске генерируется или передаётся через переменную окружения `SECRET_TOKEN` 64-байтный hex-токен.
2. Весь веб-интерфейс и API доступны только под путём `/{SECRET_TOKEN}` (например, `http://IP:3000/a7f3d8…`) и недоступны по другим маршрутам.
3. Все запросы на другие пути должны возвращать HTTP 404.

### 2.3. REST-API для управления и статуса

Базовый путь API: `/{SECRET_TOKEN}/api/radio`

1. GET `/status`
    - Описание: возвращает текущее состояние устройства
    - Ответ JSON:

```json
{
  "success": true,
  "timestamp": "2025-08-20T15:00:00.000Z",
  "data": {
    "State": "Power ON",
    "Volume": "12",
    "Station": "15 SpokoinoeRadio",
    "Title": "Art Of Noise - Moments in Love",
    "Log": "STEREO 16 bit 44 kHz MP3 128 kb/s",
    "FreeHeap": "168164",
    "Alarm": "21600"
  }
}
```

    - Источник данных: объект `radioState`, обновляемый подписками на топики.
2. POST `/station`
    - Тело запроса JSON `{ "station": <номер_станции> }`
    - Преобразование команды: `st<номер>` (например, `st15`)
    - Публикация в `Home/WebRadio2/Action`
    - Ответ JSON `{ "success": true, "command": "st15", "station": 15 }`
3. POST `/volume`
    - Тело запроса `{ "volume": <0–21> }`
    - Преобразование: `v<volume>` (например, `v12`)
    - Публикация, ответ `{ "success": true, "command": "v12", "volume": 12 }`
4. POST `/power`
    - Тело `{ "state": "on"|"off" }`
    - Команды: `power_on` или `power_off`
    - Публикация, ответ `{ "success": true, "command": "power_on", "state": "on" }`
5. POST `/alarm`
    - Тело `{ "seconds": <0–86400> }`
    - Команда: `s<seconds>` (например, `s21600`)
    - Публикация, ответ `{ "success": true, "command": "s21600", "seconds": 21600 }`
6. POST `/command`
    - Универсальный endpoint `{ "command": "<строка>" }`
    - Пробрасывает в `Home/WebRadio2/Action` неизменённой.

### 2.4. Web-интерфейс (frontend)

1. Статический SPA: HTML5 + CSS3 + Vanilla JS (ES6+)
2. Компоновка:
    - **Информационный блок**: отображение Station, State, Volume, Alarm, Title, Log.
    - **Управляющие кнопки**: POWER, CH +/-, VOL +/-, SLEEP.
    - **Сетка предустановленных станций**: кнопки 1–22, цветовая схема из прошивки.
3. Логика взаимодействия:
    - Fetch API для запросов к REST-API через секретный путь.
    - Автоматический polling GET `/status` каждые 2 секунды.
    - Обработка ошибок сети и показ состояния «Offline».
4. Адаптивность: мобильный и десктопный виды.
5. Размещение файлов в директории `public/` и раздача через Express.static по секретному пути.

## 3. Архитектура и развёртывание

1. **VPS (Ubuntu 22)**
    - Mosquitto на порту 1883 (локальный listener 127.0.0.1:1883)
    - Node.js приложение на порту 3000, привязано к localhost
2. **Reverse proxy (опционально)**
    - Nginx не требуется, т. к. внешнего доступа по HTTP/HTTPS нет
3. **Firewall/UFW**
    - Разрешить входящие TCP 3000 (если нужен прямой доступ)
    - Запретить все остальные внешние подключения к порту 3000/1883
4. **Systemd-служба**
    - `radio-interface.service` с передачей `SECRET_TOKEN`
    - Автозапуск, перезапуск при сбоях, логирование через journald

## 4. Безопасность «секретной ссылки»

1. Секретный путь с 64-char hex токеном обеспечивает защиту «по неизвестности».
2. Все маршруты API и статика доступны исключительно под этим префиксом.
3. Логи сервера должны быть настроены без вывода полного URL в публичные лог-системы.
4. Рекомендуется хранить `SECRET_TOKEN` в безопасном месте (файл .env с доступом 600 или переменная окружения).
5. Дополнительно можно ограничить доступ UFW по IP (whitelist локальной сети или VPN).

## 5. Настройка и конфигурация

1. Клонировать репозиторий с кодом моста и фронтенда.
2. В корне проекта `.env` со строкой

```env
SECRET_TOKEN=<ваш_64-символьный_HEX_токен>
```

3. Установить зависимости:

```bash
npm install express mqtt cors
```

4. Запустить в режиме отладки:

```bash
export SECRET_TOKEN=...
node server.js
```

5. Для продакшена создать `/etc/systemd/system/radio-interface.service` и активировать:

```
Environment=SECRET_TOKEN=<...>
ExecStart=/usr/bin/node /path/to/server.js
```

6. Перезапустить systemd и убедиться, что URL `http://VPS_IP:3000/<SECRET_TOKEN>/` открывает интерфейс.

## 6. Используемые MQTT-топики

Из прошивки ESP32 (фрагменты кода):

- Команды (подписка):

```
Home/WebRadio2/Action
```

- Статус (публикации ESP32):

```
Home/WebRadio2/State      → "Power ON"/"Power OFF"/"ON SLEEP"
Home/WebRadio2/Volume     → "<0–21>"
Home/WebRadio2/Station    → "<номер> <название>"
Home/WebRadio2/Title      → "<имя_трека>"
Home/WebRadio2/Log        → "<audio info>"
Home/WebRadio2/FreeHeap   → "<число>"
Home/WebRadio2/Alarm      → "<секунды>" или "Alarm OFF"
```


Код сервера должен подписаться на все статусные топики и при получении обновления сохранять их в объект `radioState`.

***

**Конец ТЗ**