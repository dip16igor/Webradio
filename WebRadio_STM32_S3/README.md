[English Version](README_EN.md)

# ESP32 Wrover Web Radio

Многофункциональный интернет-радио плеер на базе модуля ESP32 Wrover. Проект позволяет прослушивать потоковое аудио из интернета, отображать информацию на OLED-дисплее и управляться с помощью физических кнопок, по протоколу MQTT и через Telegram-бота.

## Возможности

- **Потоковое аудио:** Проигрывание интернет-радиостанций из предустановленного списка.
- **Качественный звук:** Вывод звука через I2S на внешний ЦАП (например, MAX98357A или PCM5102).
- **Информативный дисплей:** 128x64 SSD1306 OLED-дисплей для отображения статуса:
  - Номер и название станции
  - Название текущего трека (Stream Title)
  - Время (синхронизация по NTP)
  - Уровень громкости
  - Уровень сигнала WiFi (RSSI)
  - Статус питания и режима сна (Sleep)
- **Гибкое управление:**
  - **Физические кнопки:** Управление питанием, режимом сна и переключением станций.
  - **MQTT:** Полное удаленное управление и мониторинг состояния.
  - **Telegram Бот:** Базовые команды, получение статуса и обновление прошивки "по воздуху" (OTA).
- **Автоматизация:**
  - **Будильники:** Настройка времени автоматического включения и выключения.
  - **Таймер сна (Sleep):** Плавное уменьшение громкости с последующим выключением.
- **Надёжность:**
  - Автоматическое переподключение к WiFi и аудиопотоку при обрыве связи.
  - Сохранение настроек будильника в энергонезависимой памяти (EEPROM).
- **Конфигурация:** Поддержка двух аппаратных конфигураций через макрос `ESP_WROVER`.

## Аппаратные компоненты

- Модуль ESP32 Wrover.
- I2S ЦАП (например, MAX98357A, PCM5102).
- I2C OLED-дисплей 128x64 на контроллере SSD1306.
- Тактовые кнопки (минимум 4).
- Опционально: реле для управления внешним усилителем, FM-трансмиттер.

### Схема подключения (Pinout)

| Пин ESP32 | Назначение        |
| :-------- | :---------------- |
| `25`      | I2S DOUT (DIN)    |
| `27`      | I2S BCLK          |
| `26`      | I2S LRC           |
| `19`      | Кнопка POWER      |
| `15`      | Кнопка SLEEP      |
| `18`      | Кнопка CH+ (UP)   |
| `4`       | Кнопка CH- (DOWN) |
| `2`       | LED (синий)       |
| `32`      | Реле 1            |
| `33`      | Реле 2            |
| `23`      | Питание FM-TX     |
| `21`      | I2C SDA (OLED)    |
| `22`      | I2C SCL (OLED)    |

## Программное обеспечение и библиотеки

Проект создан с использованием PlatformIO. Основные зависимости:

- `espressif/arduino-esp32`
- `schreibfaul/Audio`
- `olikraus/U8g2`
- `GyverLibs/EncButton`
- `PaulStoffregen/Time`
- `PaulStoffregen/TimeAlarms`
- `arduino-libraries/NTPClient`
- `GyverLibs/FastBot`
- `knolleary/PubSubClient`

## Настройка

Все основные настройки производятся в файле `src/main.cpp`:

1.  **WiFi:** Добавьте SSID и пароли ваших сетей в массивы `ssidList` и `passwordList`.

    ```cpp
    const char *ssidList[] = {"your_ssid1", "your_ssid2"};
    const char *passwordList[] = {"your_pass1", "your_pass2"};
    ```

2.  **Telegram:** Укажите токен вашего бота в `BOT_TOKEN` и ваш ID администратора в `idAdmin1`.

    ```cpp
    #define BOT_TOKEN "YOUR_TELEGRAM_BOT_TOKEN"
    String idAdmin1 = "YOUR_TELEGRAM_CHAT_ID";
    ```

3.  **MQTT:** Настройте адрес сервера, логин и пароль.

    ```cpp
    const char *mqtt_server = "your_mqtt_broker_ip";
    #define login "your_mqtt_login"
    #define pass "your_mqtt_password"
    ```

4.  **Радиостанции:** Список URL-адресов радиостанций находится в массиве `listStation`.

## Управление

### Физические кнопки

- **POWER:** Включение/выключение устройства. Удержание - перезагрузка.
- **SLEEP:** Активация/деактивация таймера сна. Удержание - вкл/выкл FM-трансмиттера.
- **CH+ / CH-:** Переключение станций. Удержание - изменение громкости.

### MQTT

Топики зависят от макроса `ESP_WROVER` (`WebRadio1` или `WebRadio2`).

- **Входящие команды (topic_in):** `Home/WebRadioX/Action`

  - `?`: Запросить текущий статус.
  - `1` / `0`: Включить / выключить.
  - `b1` / `b2` / `b3` / `b4`: Эмуляция нажатия кнопок Power / Sleep / CH+ / CH-.
  - `vol+` / `vol-`: Увеличить / уменьшить громкость.
  - `c<N>`: Включить и переключиться на станцию с номером `N`.
  - `h<url>`: Проигрывать поток по указанному `url`.
  - `s<seconds>`: Установить будильник (время в секундах от полуночи).
  - `sAlarm OFF`: Отключить будильник.

- **Исходящие статусы (topic\_\*):**
  - `Home/WebRadioX/Log`: Общие сообщения и информация об аудиопотоке.
  - `Home/WebRadioX/Station`: Текущая станция (номер и имя).
  - `Home/WebRadioX/Title`: Название трека.
  - `Home/WebRadioX/State`: Состояние (Power ON/OFF, ON SLEEP).
  - `Home/WebRadioX/FreeHeap`: Свободная память.
  - `Home/WebRadioX/Volume`: Уровень громкости.
  - `Home/WebRadioX/Alarm`: Статус будильника.

### Telegram Бот

- `/start`: Показать меню команд.
- `/ping`: Получить статус, аптайм и RSSI.
- `/restart`: Перезагрузить устройство.
- **Отправка `.bin` файла:** Запуск обновления прошивки (OTA).

## Сборка и прошивка

1.  Установите Visual Studio Code с расширением PlatformIO IDE.
2.  Клонируйте репозиторий.
3.  Откройте папку с проектом в VS Code.
4.  Выполните настройку в `src/main.cpp` (см. раздел "Настройка").
5.  Соберите и прошейте устройство с помощью команд PlatformIO.
